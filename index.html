<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#000000">

<!-- iOS app-like behavior -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="HABIT.EXE">

<!-- iOS icons -->
<link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="./icons/icon-512.png">
  <title>HABIT.EXE</title>
  <style>
    :root{
      --bg:#000;
      --fg:#d6d6d6;
      --dim:#9a9a9a;
      --line:#5f5f5f;
      --hi:#ffffff;
      --accent:#bfbfbf;
      --good:#9cff9c;
      --bad:#ff9c9c;
      --btn:#111;
      --btnBorder:#6a6a6a;
    }

    html,body{height:100%;}
    body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

  /* phone-friendly: start at top + allow scrolling */
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:10px;
  overflow:auto;
}

    /* DOS screen container */
    .screen{
  width:min(980px, 100%);
  border:2px solid var(--line);
  background:#000;
  padding:10px;

  display:flex;
  flex-direction:column;
  gap:10px;
}

    .rowTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:8px;
    }

    .title{
      font-weight:800;
      color:var(--hi);
      letter-spacing:.6px;
    }

    .sub{
      color:var(--dim);
      font-size:12px;
      margin-top:2px;
    }

    .rightInfo{
      text-align:right;
      color:var(--dim);
      font-size:12px;
      line-height:1.3;
      white-space:nowrap;
    }

    /* Buttons (clickable) */
    .btnBar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;

  /* bottom bar */
  position: sticky;
  bottom: 0;
  background: #000;
  padding: 10px 0 0;
  border-top: 1px solid var(--line);
z-index: 9999;
pointer-events: auto;
}
    .btn{
  appearance:none;
  border:1px solid var(--btnBorder);
  background:var(--btn);
  color:var(--fg);
  padding:8px 10px;
  font:inherit;
  font-size:13px;
  cursor:pointer;
  min-height:38px;

  /* prevent iOS double-tap zoom on controls */
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
    .btn:hover{ border-color:var(--hi); color:var(--hi); }
    .btn:active{ transform: translateY(1px); }
    .btn .k{ color:var(--dim); }
    .btn.primary{ border-color:var(--hi); }
    .btn.danger{ border-color:var(--bad); color:var(--bad); }

    /* DOS box text area */
    pre.dos{
      margin:0;
      border:1px solid var(--line);
      padding:10px;
      white-space:pre;
      overflow:auto;
      min-height:420px;
      line-height:1.25;
      font-size:14px;
    }

    .footerHint{
      margin-top:10px;
      color:var(--dim);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Modal */
    .modalWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    .modal{
      width:min(520px, 100%);
      border:2px solid var(--line);
      background:#000;
      color:var(--fg);
    }
    .modalHead{
      border-bottom:1px solid var(--line);
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modalHead .t{ color:var(--hi); font-weight:800; }
    .modalBody{ padding:10px; }
    label{ display:block; color:var(--dim); font-size:12px; margin-top:8px; }
    input{
      width:100%;
      margin-top:6px;
      padding:10px;
      background:#050505;
      color:var(--fg);
      border:1px solid var(--line);
      font:inherit;
      font-size:14px;
    }
textarea:focus{ outline:none; border-color:var(--hi); }
    input:focus{ outline:none; border-color:var(--hi); }
    .modalBtns{
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
      padding:10px; border-top:1px solid var(--line);
    }
    .err{ color:var(--bad); font-size:12px; margin-top:8px; min-height:16px; }
  </style>
</head>
<body>
  <div class="screen" role="application" aria-label="HABIT.EXE">
    <div class="rowTop">
      <div>
        <div class="title">HABIT.EXE</div>
        <div class="sub">DOS-style habit tracker · offline (localStorage)</div>
      </div>
      <div class="rightInfo">
        <div id="dateLine"></div>
        <div id="viewLine"></div>
      </div>
    </div>

     <pre class="dos" id="dosOut"></pre>
<div id="historyWrap" style="display:none; border:1px solid var(--line); padding:10px; overflow:auto; max-height:520px;">
  <div style="color:var(--hi); font-weight:800; margin-bottom:8px;">HISTORY</div>
  <div id="historyRows"></div>
</div>
<!-- Clickable buttons -->
    <div class="btnBar">
  <button class="btn" id="btnToday">Today</button>

  <button class="btn primary" id="btnAdd">Add <span class="k">(A)</span></button>
  <button class="btn" id="btnToggle">Toggle <span class="k">(Space)</span></button>

  <button class="btn" id="btnUp">Up <span class="k">(↑)</span></button>
  <button class="btn" id="btnDown">Down <span class="k">(↓)</span></button>

  <button class="btn" id="btnEdit">Edit <span class="k">(E)</span></button>
  <button class="btn danger" id="btnDelete">Delete <span class="k">(D)</span></button>

  <button class="btn" id="btnSettings">Settings <span class="k">(S)</span></button>
  <button class="btn" id="btnHistory">History <span class="k">(H)</span></button>
  <button class="btn" id="btnGraph">Graph <span class="k">(G)</span></button>
<button class="btn" id="btnDiary">Diary</button>
  <button class="btn" id="btnReset">Reset today <span class="k">(R)</span></button>
</div>

   

    <div class="footerHint">
      <div id="footerMsg">Ready.</div>
      <div>↑/↓ select · Space toggle · ESC back</div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalWrap" id="modalWrap">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
  <div class="t" id="modalTitle">DIALOG</div>
  <div style="display:flex; gap:10px; align-items:center;">
    <div class="sub" style="margin:0" id="modalHelp">Enter save · ESC cancel</div>
    <button class="btn" id="modalCloseBtn" style="min-height:30px; padding:4px 10px;">✕</button>
  </div>
</div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalBtns" id="modalBtns"></div>
    </div>
  </div>

<script>
(() => {
  const LS_KEY = "HABIT_EXE_V2_DOS_RESET1";
  const $ = (id) => document.getElementById(id);

  const state = {
  view: "today", // today | history | graph
  selectedIndex: 0,
  historySelectedKey: null
};

  function setFooter(msg){ $("footerMsg").textContent = msg; }

  // IMPORTANT: currently uses UTC date key (same as v1).
  // If you want strict Auckland local day keys, say "switch to NZ local day keys".
  function dayKeyLocal(d = new Date()){
  // Local device day: YYYY-MM-DD
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const da = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${da}`;
}

  function fmtDateLabel(){
    const d = new Date();
    const opts = { weekday:"short", year:"numeric", month:"short", day:"2-digit" };
    return d.toLocaleDateString(undefined, opts);
  }

  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) {
      const initial = {
        settings: { minPercent: 70 },
        habits: [
          { id: crypto.randomUUID(), name: "Workout" },
          { id: crypto.randomUUID(), name: "Water 2L" },
          { id: crypto.randomUUID(), name: "Read 20m" },
          { id: crypto.randomUUID(), name: "Code 1h" },
        ],
        days: {}
      };
      localStorage.setItem(LS_KEY, JSON.stringify(initial));
      return initial;
    }
    try { return JSON.parse(raw); } catch { localStorage.removeItem(LS_KEY); return load(); }
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

  let db = load();

  function ensureDay(key){
  if (!db.days[key]) db.days[key] = {
    checked: {},
    diary: "",
    percent: 0,
    closed: false,
    done: 0,
    total: 0
  };
}

  function computeDay(key){
  ensureDay(key);
  const day = db.days[key];

  let total = db.habits.length;
  let done = 0;

  for (const h of db.habits) if (day.checked[h.id]) done++;

  // Diary "secret habit" BONUS: only counts if filled (no penalty if empty)
  const diaryFilled = !!String(day.diary || "").trim();
  if (diaryFilled){
    total += 1;
    done += 1;
  }

  let percent = total === 0 ? 0 : Math.round((done / total) * 100);
  percent = Math.max(0, Math.min(100, percent));

  const closed = percent >= db.settings.minPercent;

  day.total = total;
  day.done = done;
  day.percent = percent;
  day.closed = closed;

  save();
  return day;
}

function isTodayClosed(){
  const key = dayKeyLocal();
  ensureDay(key);
  return computeDay(key).closed;
}

  function padRight(s, n){
    s = String(s);
    return s.length >= n ? s.slice(0,n) : (s + " ".repeat(n - s.length));
  }

  function drawBox(lines, width){
    // lines: array of strings (no \n)
    // width: inside width
    const top = "┌" + "─".repeat(width) + "┐";
    const bot = "└" + "─".repeat(width) + "┘";
    const mid = lines.map(l => "│" + padRight(l, width) + "│");
    return [top, ...mid, bot].join("\n");
  }
function computeStreaksLocal(){
  // Map stored day -> closed
  const closedByDay = new Map();
  for (const k of Object.keys(db.days)){
    const d = computeDay(k);
    closedByDay.set(k, !!d.closed);
  }

  // Current streak: walk backward from today (local)
  let currentStreak = 0;
  const today = new Date();
  for (let i = 0; i < 5000; i++){
    const dt = new Date(today);
    dt.setDate(today.getDate() - i);
    const k = dayKeyLocal(dt);
    if (closedByDay.get(k)) currentStreak++;
    else break;
  }

  // Best streak: scan sorted keys and count consecutive closed days
  const keys = Array.from(closedByDay.keys()).sort();
  let bestStreak = 0;
  let run = 0;

  for (const k of keys){
    if (closedByDay.get(k)){
      run++;
      if (run > bestStreak) bestStreak = run;
    } else {
      run = 0;
    }
  }

  return { currentStreak, bestStreak };
}

  function render(){
    $("dateLine").textContent = fmtDateLabel();
    $("viewLine").textContent = "VIEW: " + state.view.toUpperCase();
    if (state.view === "today") renderToday();
    if (state.view === "history") renderHistory();
    if (state.view === "graph") renderGraph();
  }

function renderToday(){
  const key = dayKeyLocal();
  const day = computeDay(key);

  state.selectedIndex = Math.min(state.selectedIndex, Math.max(0, db.habits.length - 1));

  const w = 62;

  // --- streaks ---
  const { currentStreak, bestStreak } = computeStreaksLocal();

  const header1 = `HABIT.EXE  TODAY: ${key}`;
  const header2 = `DONE: ${day.done}/${day.total}   SCORE: ${day.percent}%   MIN: ${db.settings.minPercent}%`;
  const header3 = `STREAK: ${currentStreak}  (BEST: ${bestStreak})`;
  const status = day.closed
  ? "STATUS: CLOSED (LOCKED)"
  : `STATUS: OPEN (need +${Math.max(0, db.settings.minPercent - day.percent)}%)`;

  const lines = [];
  lines.push(padRight(header1, w));
  lines.push(padRight(header2, w));
  lines.push(padRight(header3, w));
  lines.push(padRight(status, w));
  lines.push("");

  if (db.habits.length === 0){
    lines.push("No habits yet. Press A or click Add.");
  } else {
    for (let i=0;i<db.habits.length;i++){
      const h = db.habits[i];
      const checked = !!db.days[key]?.checked?.[h.id];
      const cursor = (i === state.selectedIndex) ? "►" : " ";
      const box = checked ? "x" : " ";
      lines.push(`${cursor} [${box}] ${h.name}`);
    }
  }

  
  $("dosOut").textContent = drawBox(lines, w);
}

  function renderHistory(){
  const rows = $("historyRows");
  rows.innerHTML = "";

  const keys = Object.keys(db.days).sort((a,b)=> b.localeCompare(a)); // ALL

  if (keys.length === 0){
    const empty = document.createElement("div");
    empty.style.color = "var(--dim)";
    empty.textContent = "No history yet. Toggle habits today to create records.";
    rows.appendChild(empty);
    state.historySelectedKey = null;
    return;
  }

  // auto-select most recent if none selected
  if (!state.historySelectedKey || !db.days[state.historySelectedKey]) {
    state.historySelectedKey = keys[0];
  }

  for (const k of keys){
    const d = computeDay(k);

    const line = document.createElement("div");
    line.style.display = "flex";
    line.style.alignItems = "center";
    line.style.gap = "8px";
    line.style.padding = "6px 0";
    line.style.borderBottom = "1px solid rgba(95,95,95,.35)";

    const pick = document.createElement("button");
    pick.className = "btn";
    pick.textContent = (k === state.historySelectedKey) ? "►" : " ";
    pick.style.minHeight = "32px";
    pick.style.padding = "4px 10px";
    pick.onclick = () => { state.historySelectedKey = k; renderHistory(); };

    const txt = document.createElement("div");
    txt.style.flex = "1 1 auto";
    txt.style.whiteSpace = "nowrap";
    txt.style.overflow = "hidden";
    txt.style.textOverflow = "ellipsis";
    txt.style.color = "var(--fg)";
    const st = d.closed ? "CLOSED" : "OPEN";
    txt.textContent = `${k}   ${String(d.percent).padStart(3," ")}%   ${st}   ${d.done}/${d.total}`;

    const diaryBtn = document.createElement("button");
    diaryBtn.className = "btn";
    diaryBtn.textContent = "Diary";
    diaryBtn.style.minHeight = "32px";
    diaryBtn.style.padding = "4px 10px";
    diaryBtn.onclick = () => diaryForDay(k);

    line.append(pick, txt, diaryBtn);
    rows.appendChild(line);
  }
}

  function renderGraph(){
    const w = 62;
    const lines = [];
    lines.push("GRAPH (last 30 days)  █=5%  ✓=closed");
    lines.push("");

    const now = new Date();
    for (let i=29;i>=0;i--){
      const d = new Date(now);
      d.setDate(now.getDate()-i);
      const key = dayKeyLocal(d);
      ensureDay(key);
      const day = computeDay(key);
      const blocks = Math.round(day.percent/5); // 0..20
      const bar = "█".repeat(blocks) + "░".repeat(20-blocks);
      const tick = day.closed ? "✓" : " ";
      lines.push(`${key}  ${String(day.percent).padStart(3," ")}%  ${bar}  ${tick}`);
    }

    lines.push("");
    lines.push("Press ESC to go back.");
    $("dosOut").textContent = drawBox(lines, w);
  }

  function setView(v){
  // ✅ if a modal is open (Diary/Add/Edit/etc), close it so it can't sit on top
  if ($("modalWrap").style.display === "flex") {
    closeModal();
  }

  state.view = v;

  // toggle panels
  $("dosOut").style.display = (v === "history") ? "none" : "";
  $("historyWrap").style.display = (v === "history") ? "" : "none";

  render();
}

  function moveSelection(dir){
    if (state.view !== "today") return;
    if (db.habits.length === 0) return;
    state.selectedIndex = (state.selectedIndex + dir + db.habits.length) % db.habits.length;
    renderToday();
  }

  function toggleSelected(){
  if (state.view !== "today") return;

  const key = dayKeyLocal(); // or dayKeyNZ() if you kept NZ-only
  if (db.habits.length === 0) return;

  ensureDay(key);
  const day = computeDay(key);

  // ✅ lock once closed
  if (day.closed){
    setFooter("Day is CLOSED. Use 'Reset today' to unlock.");
    return;
  }

  const h = db.habits[state.selectedIndex];
  const cur = !!db.days[key].checked[h.id];
  db.days[key].checked[h.id] = !cur;

  computeDay(key);
  setFooter((cur ? "Unchecked: " : "Checked: ") + h.name);
  renderToday();
}

  // ---- modal helpers ----
  function openModal({title, bodyNodes, buttons, onEnter}){
$("modalCloseBtn").onclick = closeModal;
    $("modalWrap").style.display = "flex";
    $("modalTitle").textContent = title || "DIALOG";
    const body = $("modalBody");
    const btns = $("modalBtns");
    body.innerHTML = "";
    btns.innerHTML = "";
    for (const n of bodyNodes) body.appendChild(n);

    for (const b of buttons){
      const el = document.createElement("button");
      el.className = "btn " + (b.cls || "");
      el.textContent = b.text;
      el.addEventListener("click", b.onClick);
      btns.appendChild(el);
    }

    // focus first input if exists
    setTimeout(() => body.querySelector("input")?.focus(), 0);

    window._modalKeyHandler = (e) => {
      if (e.key === "Escape"){ e.preventDefault(); closeModal(); }
      if (e.key === "Enter" && onEnter){ e.preventDefault(); onEnter(); }
    };
    document.addEventListener("keydown", window._modalKeyHandler, {capture:true});
  }

  function closeModal(){
  $("modalWrap").style.display = "none";
  $("modalWrap").onclick = null; // ✅ remove outside-tap handler

  if (window._modalKeyHandler){
    document.removeEventListener("keydown", window._modalKeyHandler, {capture:true});
    window._modalKeyHandler = null;
  }
  render();
}

  function addHabit(){
if (isTodayClosed()){
  setFooter("Day is CLOSED. Reset today to add habits.");
  return;
}
  const wrap = document.createElement("div");
  const lab = document.createElement("label");
  lab.textContent = "Habit name";
  const inp = document.createElement("input");
  inp.placeholder = "e.g., Stretch 10m";
  const err = document.createElement("div");
  err.className = "err";
  wrap.append(lab, inp, err);

  let savedAlready = false;

  const doSave = () => {
    if (savedAlready) return; // prevents double tap / key repeat
    const name = inp.value.trim();
    if (!name){ err.textContent = "Name cannot be empty."; return; }

    savedAlready = true;
    db.habits.push({ id: crypto.randomUUID(), name });
    save(); // <-- correct: persist to localStorage

    setFooter("Added: " + name);
    closeModal();
  };

  openModal({
    title:"ADD HABIT",
    bodyNodes:[wrap],
    buttons:[
      { text:"Cancel", onClick: closeModal },
      { text:"Save", cls:"primary", onClick: doSave }
    ],
    onEnter: doSave
  });
}

  function editHabit(){
if (isTodayClosed()){
  setFooter("Day is CLOSED. Reset today to edit habits.");
  return;
}
    if (state.view !== "today" || db.habits.length === 0) return;
    const h = db.habits[state.selectedIndex];

    const wrap = document.createElement("div");
    const lab = document.createElement("label");
    lab.textContent = "Habit name";
    const inp = document.createElement("input");
    inp.value = h.name;
    const err = document.createElement("div");
    err.className = "err";
    wrap.append(lab, inp, err);

    const apply = () => {
      const name = inp.value.trim();
      if (!name){ err.textContent = "Name cannot be empty."; return; }
      h.name = name;
      save();
      setFooter("Updated.");
      closeModal();
    };

    openModal({
      title:"EDIT HABIT",
      bodyNodes:[wrap],
      buttons:[
        { text:"Cancel", onClick: closeModal },
        { text:"Update", cls:"primary", onClick: apply }
      ],
      onEnter: apply
    });
  }

  function deleteHabit(){
if (isTodayClosed()){
  setFooter("Day is CLOSED. Reset today to delete habits.");
  return;
}
    if (state.view !== "today" || db.habits.length === 0) return;
    const h = db.habits[state.selectedIndex];

    const p = document.createElement("div");
    p.style.color = "var(--fg)";
    p.textContent = `Delete "${h.name}" ?`;

    const del = () => {
      db.habits = db.habits.filter(x => x.id !== h.id);
      for (const dk of Object.keys(db.days)){
        delete db.days[dk].checked[h.id];
      }
      save();
      state.selectedIndex = Math.max(0, state.selectedIndex - 1);
      setFooter("Deleted: " + h.name);
      closeModal();
    };

    openModal({
      title:"DELETE HABIT",
      bodyNodes:[p],
      buttons:[
        { text:"Cancel", onClick: closeModal },
        { text:"Delete", cls:"danger", onClick: del }
      ],
      onEnter: del
    });
  }

  function settings(){
    const wrap = document.createElement("div");
    const lab = document.createElement("label");
    lab.textContent = "Minimum % to close the day (0-100)";
    const inp = document.createElement("input");
    inp.value = String(db.settings.minPercent);
    inp.inputMode = "numeric";
    const err = document.createElement("div");
    err.className = "err";
    wrap.append(lab, inp, err);

    const saveSet = () => {
      const n = Number(inp.value.trim());
      if (!Number.isFinite(n) || n < 0 || n > 100){
        err.textContent = "Enter a number from 0 to 100.";
        return;
      }
      db.settings.minPercent = Math.round(n);
      save();
      setFooter("MIN% set to " + db.settings.minPercent + "%.");
      closeModal();
    };

    openModal({
      title:"SETTINGS",
      bodyNodes:[wrap],
      buttons:[
        { text:"Cancel", onClick: closeModal },
        { text:"Save", cls:"primary", onClick: saveSet }
      ],
      onEnter: saveSet
    });
  }
function diaryForDay(dayKey){
  ensureDay(dayKey);

  const wrap = document.createElement("div");

  const lab = document.createElement("label");
  lab.textContent = `Diary entry for ${dayKey}`;

  const ta = document.createElement("textarea");
  ta.style.width = "100%";
  ta.style.minHeight = "180px";
  ta.style.marginTop = "6px";
  ta.style.background = "#050505";
  ta.style.color = "var(--fg)";
  ta.style.border = "1px solid var(--line)";
  ta.style.font = "inherit";
  ta.style.fontSize = "14px";
  ta.value = db.days[dayKey].diary || "";
  ta.placeholder = "Write notes about your day...";

  const err = document.createElement("div");
  err.className = "err";

  wrap.append(lab, ta, err);

  const saveDiary = () => {
    db.days[dayKey].diary = ta.value;
    computeDay(dayKey);
    save();
    setFooter("Diary saved for " + dayKey);
    closeModal();
  };

  openModal({
    title:"DIARY",
    bodyNodes:[wrap],
    buttons:[
      { text:"Cancel", onClick: closeModal },
      { text:"Save", cls:"primary", onClick: saveDiary }
    ],
    onEnter: saveDiary
  });

  setTimeout(() => ta.focus(), 0);
}
  function resetToday(){
    const key = dayKeyLocal();
    const p = document.createElement("div");
    p.textContent = `Reset all checkmarks for ${key}?`;

    const go = () => {
      ensureDay(key);
      db.days[key].checked = {};
      computeDay(key);
      save();
      setFooter("Today reset.");
      closeModal();
    };

    openModal({
      title:"RESET TODAY",
      bodyNodes:[p],
      buttons:[
        { text:"Cancel", onClick: closeModal },
        { text:"Reset", cls:"danger", onClick: go }
      ],
      onEnter: go
    });
  }

  // Keyboard controls
  document.addEventListener("keydown", (e) => {
    if ($("modalWrap").style.display === "flex") return;

    if (e.key === "ArrowUp"){ e.preventDefault(); moveSelection(-1); }
    if (e.key === "ArrowDown"){ e.preventDefault(); moveSelection(+1); }
    if (e.key === " "){ e.preventDefault(); toggleSelected(); }

    const k = e.key.toLowerCase();
    if (k === "a"){ e.preventDefault(); addHabit(); }
    if (k === "e"){ e.preventDefault(); editHabit(); }
    if (k === "d"){ e.preventDefault(); deleteHabit(); }
    if (k === "s"){ e.preventDefault(); settings(); }
    if (k === "h"){ e.preventDefault(); setView("history"); setFooter("History."); }
    if (k === "g"){ e.preventDefault(); setView("graph"); setFooter("Graph."); }
    if (k === "r"){ e.preventDefault(); resetToday(); }

    if (e.key === "Escape"){
      if (state.view !== "today"){
        e.preventDefault();
        setView("today");
        setFooter("Back to Today.");
      }
    }
  });

// Hook up clickable buttons (safe)
function wireButtons(){
  const q = (id) => document.getElementById(id);

  q("btnToday")?.addEventListener("click", () => { setView("today"); setFooter("Back to Today."); });

  q("btnAdd")?.addEventListener("click", addHabit);
  q("btnToggle")?.addEventListener("click", toggleSelected);

  q("btnUp")?.addEventListener("click", () => moveSelection(-1));
  q("btnDown")?.addEventListener("click", () => moveSelection(+1));

  q("btnEdit")?.addEventListener("click", editHabit);
  q("btnDelete")?.addEventListener("click", deleteHabit);

  q("btnSettings")?.addEventListener("click", settings);
  q("btnHistory")?.addEventListener("click", () => { setView("history"); setFooter("History."); });
  q("btnGraph")?.addEventListener("click", () => { setView("graph"); setFooter("Graph."); });

  q("btnReset")?.addEventListener("click", resetToday);

  // ✅ Diary button must always open today's diary (or selected history day)
  q("btnDiary")?.addEventListener("click", () => {
    try{
      const key = (state.view === "history" && state.historySelectedKey)
  ? state.historySelectedKey
  : dayKeyLocal();

      diaryForDay(key);
    } catch (err) {
      setFooter("Diary error: " + (err?.message || err));
    }
  });
}

// Ensure elements exist before wiring
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", wireButtons);
} else {
  wireButtons();
}

  render();
  setFooter("Ready. Click buttons or use keys.");
})();
</script>
<script>
  // PWA offline caching
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }
</script>
</body>
</html>